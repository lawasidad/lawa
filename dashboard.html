<script>
  const ordersContainer = document.getElementById('ordersContainer');

  function getOrders() {
    try {
      const data = localStorage.getItem('orders');
      return data ? JSON.parse(data) : [];
    } catch {
      return [];
    }
  }

  function createProductHTML(product) {
    return `
      <div class="product">
        <img src="${product.image}" alt="${product.name}" />
        <div class="product-name">${product.name}</div>
        <div class="product-price">${product.price.toLocaleString()} دینار</div>
      </div>
    `;
  }

  function renderOrders() {
    const orders = getOrders();

    if (orders.length === 0) {
      ordersContainer.innerHTML = '<p class="no-orders">هیچ داواکاریەک نییە.</p>';
      return;
    }

    ordersContainer.innerHTML = '';

    orders.forEach(order => {
      const productsHTML = order.products.map(createProductHTML).join('');

      const orderHTML = document.createElement('div');
      orderHTML.className = 'order';

      orderHTML.innerHTML = `
        <div class="order-header">
          <span>ناوی کریار: ${order.name}</span>
          <span>ژمارە مۆبایل: ${order.mobile}</span>
        </div>
        <div class="order-info">
          ناونیشان: ${order.address || '-'}<br/>
          GPS: ${order.gps || '-'}<br/>
          کاتی داواکاری: ${order.time}
        </div>
        <div class="products">${productsHTML}</div>
      `;

      ordersContainer.appendChild(orderHTML);
    });
  }

  let lastOrdersLength = 0;

  function playAlarm() {
    const audio = new Audio("https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg");
    audio.play().catch(error => {
      console.error("ناتوانێت دەنگ پێبکات:", error);
    });
  }

  function checkForNewOrders() {
    const currentOrders = getOrders();

    if (currentOrders.length > lastOrdersLength) {
      if (!document.hasFocus()) {
        playAlarm();
        alert("وەسڵی نوێ زیاد بوو!");
      }

      lastOrdersLength = currentOrders.length;
      renderOrders();
    }
  }

  window.onload = () => {
    lastOrdersLength = getOrders().length;
    renderOrders();
    setInterval(checkForNewOrders, 3000); // check every 3 seconds
  };
</script>
